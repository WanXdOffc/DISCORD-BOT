<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= guild.name %> - Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-purple-600 via-blue-600 to-indigo-700 min-h-screen text-white">
  <!-- Navbar -->
  <nav class="bg-black/20 backdrop-blur-lg border-b border-white/10 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <i class="fas fa-robot text-2xl"></i>
          <span class="text-xl font-bold">Guild Settings</span>
        </div>
        <div class="flex items-center space-x-4">
          <img src="https://cdn.discordapp.com/avatars/<%= user.id %>/<%= user.avatar %>.png" 
               alt="Avatar" class="w-10 h-10 rounded-full border-2 border-white">
          <a href="/dashboard" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg transition-all">
            <i class="fas fa-arrow-left mr-2"></i>Back
          </a>
          <a href="/logout" class="px-4 py-2 bg-red-500 hover:bg-red-600 rounded-lg transition-all">Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Guild Header -->
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20">
      <div class="flex items-center space-x-6">
        <div class="w-20 h-20 rounded-full overflow-hidden bg-white/20 flex items-center justify-center text-4xl">
          <% if (guild.icon) { %>
            <img src="<%= guild.iconURL() %>" alt="<%= guild.name %>" class="w-full h-full object-cover">
          <% } else { %><i class="fas fa-server"></i><% } %>
        </div>
        <div>
          <h1 class="text-3xl font-bold mb-2"><%= guild.name %></h1>
          <div class="flex gap-4 text-sm opacity-80">
            <span><i class="fas fa-users mr-1"></i><%= guild.memberCount %></span>
            <span><i class="fas fa-hashtag mr-1"></i><%= guild.channels.cache.size %></span>
            <span><i class="fas fa-shield-alt mr-1"></i><%= guild.roles.cache.size %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Category Tabs -->
    <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 mb-8 border border-white/20">
      <div class="flex flex-wrap gap-3">
        <button onclick="showCategory('basic')" data-category="basic" class="category-btn px-6 py-3 bg-blue-500 rounded-lg font-semibold transition-all hover:bg-blue-600">
          <i class="fas fa-cog mr-2"></i>Basic
        </button>
        <button onclick="showCategory('features')" data-category="features" class="category-btn px-6 py-3 bg-white/10 rounded-lg font-semibold transition-all hover:bg-white/20">
          <i class="fas fa-puzzle-piece mr-2"></i>Features
        </button>
        <button onclick="showCategory('welcome')" data-category="welcome" class="category-btn px-6 py-3 bg-white/10 rounded-lg font-semibold transition-all hover:bg-white/20">
          <i class="fas fa-door-open mr-2"></i>Welcome
        </button>
        <button onclick="showCategory('moderation')" data-category="moderation" class="category-btn px-6 py-3 bg-white/10 rounded-lg font-semibold transition-all hover:bg-white/20">
          <i class="fas fa-shield-alt mr-2"></i>Moderation
        </button>
        <button onclick="showCategory('economy')" data-category="economy" class="category-btn px-6 py-3 bg-white/10 rounded-lg font-semibold transition-all hover:bg-white/20">
          <i class="fas fa-coins mr-2"></i>Economy
        </button>
        <button onclick="showCategory('ai')" data-category="ai" class="category-btn px-6 py-3 bg-white/10 rounded-lg font-semibold transition-all hover:bg-white/20">
          <i class="fas fa-robot mr-2"></i>AI Chat
        </button>
      </div>
    </div>

    <!-- Settings Form -->
    <form id="settingsForm">
      <!-- Basic Settings -->
      <div id="category-basic" class="category-content">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h2 class="text-2xl font-bold mb-6"><i class="fas fa-cog mr-2"></i>Basic Settings</h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-2">Command Prefix</label>
              <input type="text" name="prefix" value="<%= settings.prefix || '!' %>" maxlength="5"
                     class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg focus:border-blue-500 focus:outline-none">
            </div>
          </div>
        </div>
      </div>

      <!-- Features Category -->
      <div id="category-features" class="category-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Music -->
          <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-music mr-2"></i>Music System</h3>
            <label class="flex items-center justify-between cursor-pointer">
              <span class="font-medium">Enable Music</span>
              <div class="relative">
                <input type="checkbox" name="features.music" class="sr-only toggle-input" 
                       <%= settings.features?.music ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
          </div>

          <!-- Leveling -->
          <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-chart-line mr-2"></i>Leveling</h3>
            <label class="flex items-center justify-between cursor-pointer mb-4">
              <span class="font-medium">Enable Leveling</span>
              <div class="relative">
                <input type="checkbox" name="features.leveling" class="sr-only toggle-input"
                       <%= settings.features?.leveling ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
            <label class="block text-sm font-medium mb-2">Level Up Channel</label>
            <select name="leveling.channelId" class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg focus:border-blue-500 focus:outline-none">
              <option value="">None</option>
              <% guild.channels.cache.filter(c => c.type === 0).forEach(channel => { %>
                <option value="<%= channel.id %>" <%= settings.leveling?.channelId === channel.id ? 'selected' : '' %>>
                  #<%= channel.name %>
                </option>
              <% }); %>
            </select>
          </div>
        </div>
      </div>

      <!-- Welcome Category -->
      <div id="category-welcome" class="category-content hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-hand-wave mr-2"></i>Welcome System</h3>
            <div class="space-y-4">
              <label class="flex items-center justify-between cursor-pointer">
                <span class="font-medium">Enable Welcome</span>
                <div class="relative">
                  <input type="checkbox" name="welcome.enabled" class="sr-only toggle-input"
                         <%= settings.welcome?.enabled ? 'checked' : '' %>>
                  <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                  <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
                </div>
              </label>
              <div>
                <label class="block text-sm font-medium mb-2">Welcome Channel</label>
                <select name="welcome.channelId" class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg focus:outline-none focus:border-blue-500">
                  <option value="">Select Channel</option>
                  <% guild.channels.cache.filter(c => c.type === 0).forEach(channel => { %>
                    <option value="<%= channel.id %>" <%= settings.welcome?.channelId === channel.id ? 'selected' : '' %>>
                      #<%= channel.name %>
                    </option>
                  <% }); %>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium mb-2">Welcome Message</label>
                <input type="text" name="welcome.message" value="<%= settings.welcome?.message || 'Welcome {user} to {server}!' %>"
                       class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg focus:outline-none focus:border-blue-500">
                <p class="text-xs opacity-60 mt-1">Variables: {user}, {server}, {memberCount}</p>
              </div>
              <label class="flex items-center justify-between cursor-pointer">
                <span class="font-medium">Welcome Card</span>
                <div class="relative">
                  <input type="checkbox" name="welcome.card" class="sr-only toggle-input"
                         <%= settings.welcome?.card ? 'checked' : '' %>>
                  <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                  <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
                </div>
              </label>
            </div>
          </div>

          <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
            <h3 class="text-xl font-bold mb-4"><i class="fas fa-door-closed mr-2"></i>Goodbye System</h3>
            <div class="space-y-4">
              <label class="flex items-center justify-between cursor-pointer">
                <span class="font-medium">Enable Goodbye</span>
                <div class="relative">
                  <input type="checkbox" name="goodbye.enabled" class="sr-only toggle-input"
                         <%= settings.goodbye?.enabled ? 'checked' : '' %>>
                  <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                  <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
                </div>
              </label>
              <div>
                <label class="block text-sm font-medium mb-2">Goodbye Channel</label>
                <select name="goodbye.channelId" class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg focus:outline-none focus:border-blue-500">
                  <option value="">Select Channel</option>
                  <% guild.channels.cache.filter(c => c.type === 0).forEach(channel => { %>
                    <option value="<%= channel.id %>" <%= settings.goodbye?.channelId === channel.id ? 'selected' : '' %>>
                      #<%= channel.name %>
                    </option>
                  <% }); %>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Moderation Category -->
      <div id="category-moderation" class="category-content hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h2 class="text-2xl font-bold mb-6"><i class="fas fa-shield-alt mr-2"></i>Moderation & Security</h2>
          <div class="space-y-4">
            <label class="flex items-center justify-between cursor-pointer p-4 bg-black/20 rounded-lg">
              <span class="font-medium">Enable Auto-Moderation</span>
              <div class="relative">
                <input type="checkbox" name="moderation.autoMod.enabled" class="sr-only toggle-input"
                       <%= settings.moderation?.autoMod?.enabled ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer p-4 bg-black/20 rounded-lg">
              <span class="font-medium">Anti-Spam (5 msg/5s → timeout)</span>
              <div class="relative">
                <input type="checkbox" name="moderation.autoMod.antiSpam" class="sr-only toggle-input"
                       <%= settings.moderation?.autoMod?.antiSpam ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer p-4 bg-black/20 rounded-lg">
              <span class="font-medium">Anti-Links (Block URLs)</span>
              <div class="relative">
                <input type="checkbox" name="moderation.autoMod.antiLinks" class="sr-only toggle-input"
                       <%= settings.moderation?.autoMod?.antiLinks ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
            <label class="flex items-center justify-between cursor-pointer p-4 bg-black/20 rounded-lg">
              <span class="font-medium">Anti-Invites (Block Discord invites)</span>
              <div class="relative">
                <input type="checkbox" name="moderation.autoMod.antiInvites" class="sr-only toggle-input"
                       <%= settings.moderation?.autoMod?.antiInvites ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
            <div>
              <label class="block text-sm font-medium mb-2">Moderation Log Channel</label>
              <select name="moderation.logChannelId" class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg focus:outline-none focus:border-blue-500">
                <option value="">None</option>
                <% guild.channels.cache.filter(c => c.type === 0).forEach(channel => { %>
                  <option value="<%= channel.id %>" <%= settings.moderation?.logChannelId === channel.id ? 'selected' : '' %>>
                    #<%= channel.name %>
                  </option>
                <% }); %>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Economy Category -->
      <div id="category-economy" class="category-content hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h2 class="text-2xl font-bold mb-6"><i class="fas fa-coins mr-2"></i>Economy System</h2>
          <div class="space-y-4">
            <label class="flex items-center justify-between cursor-pointer p-4 bg-black/20 rounded-lg">
              <span class="font-medium">Enable Economy</span>
              <div class="relative">
                <input type="checkbox" name="features.economy" class="sr-only toggle-input"
                       <%= settings.features?.economy ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
            <div>
              <label class="block text-sm font-medium mb-2">Daily Reward Amount</label>
              <input type="number" name="economy.daily.amount" value="<%= settings.economy?.daily?.amount || 100 %>"
                     min="1" max="10000"
                     class="w-full px-4 py-3 bg-black/30 border border-white/20 rounded-lg focus:outline-none focus:border-blue-500">
            </div>
          </div>
        </div>
      </div>

      <!-- AI Chat Category -->
      <div id="category-ai" class="category-content hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 border border-white/20">
          <h2 class="text-2xl font-bold mb-6"><i class="fas fa-robot mr-2"></i>AI Chat System</h2>
          <div class="space-y-4">
            <label class="flex items-center justify-between cursor-pointer p-4 bg-black/20 rounded-lg">
              <span class="font-medium">Enable AI Chat</span>
              <div class="relative">
                <input type="checkbox" name="aiChat.enabled" class="sr-only toggle-input"
                       <%= settings.aiChat?.enabled ? 'checked' : '' %>>
                <div class="toggle-bg w-14 h-7 bg-gray-600 rounded-full transition-colors"></div>
                <div class="toggle-dot absolute left-1 top-1 w-5 h-5 bg-white rounded-full transition-transform"></div>
              </div>
            </label>
            <div>
              <label class="block text-sm font-medium mb-2">AI Chat Channels (Ctrl+Click for multiple)</label>
              <select name="aiChat.channels" multiple size="6"
                      class="w-full px-4 py-2 bg-black/30 border border-white/20 rounded-lg focus:outline-none focus:border-blue-500">
                <% guild.channels.cache.filter(c => c.type === 0).forEach(channel => { %>
                  <option value="<%= channel.id %>" class="py-2 hover:bg-white/10"
                          <%= settings.aiChat?.channels?.includes(channel.id) ? 'selected' : '' %>>
                    #<%= channel.name %>
                  </option>
                <% }); %>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Save Button -->
      <div class="mt-8">
        <button type="submit" class="w-full py-4 px-6 bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 rounded-lg font-bold text-lg transition-all transform hover:scale-[1.02]">
          <i class="fas fa-save mr-2"></i>Save All Settings
        </button>
      </div>
    </form>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="fixed top-6 right-6 px-6 py-4 rounded-lg shadow-2xl hidden transform transition-all z-50"></div>

  <script>
    // Category switching
    function showCategory(category) {
      document.querySelectorAll('.category-content').forEach(el => el.classList.add('hidden'));
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('bg-blue-500');
        btn.classList.add('bg-white/10');
      });
      document.getElementById(`category-${category}`).classList.remove('hidden');
      document.querySelector(`[data-category="${category}"]`).classList.add('bg-blue-500');
      document.querySelector(`[data-category="${category}"]`).classList.remove('bg-white/10');
    }

    // Toggle switches
    document.querySelectorAll('.toggle-input').forEach(input => {
      const bg = input.nextElementSibling;
      const dot = bg.nextElementSibling;
      
      function updateToggle() {
        if (input.checked) {
          bg.classList.remove('bg-gray-600');
          bg.classList.add('bg-green-500');
          dot.style.transform = 'translateX(28px)';
        } else {
          bg.classList.add('bg-gray-600');
          bg.classList.remove('bg-green-500');
          dot.style.transform = 'translateX(0)';
        }
      }
      
      updateToggle();
      input.addEventListener('change', updateToggle);
      bg.parentElement.addEventListener('click', (e) => {
        if (e.target !== input) {
          input.checked = !input.checked;
          updateToggle();
        }
      });
    });

    // Form submission
    document.getElementById('settingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const settings = {
        prefix: formData.get('prefix'),
        features: {
          music: document.querySelector('[name="features.music"]').checked,
          leveling: document.querySelector('[name="features.leveling"]').checked,
          economy: document.querySelector('[name="features.economy"]').checked,
        },
        welcome: {
          enabled: document.querySelector('[name="welcome.enabled"]').checked,
          channelId: formData.get('welcome.channelId') || null,
          message: formData.get('welcome.message'),
          card: document.querySelector('[name="welcome.card"]').checked,
        },
        goodbye: {
          enabled: document.querySelector('[name="goodbye.enabled"]').checked,
          channelId: formData.get('goodbye.channelId') || null,
        },
        aiChat: {
          enabled: document.querySelector('[name="aiChat.enabled"]').checked,
          channels: Array.from(formData.getAll('aiChat.channels')),
        },
        leveling: {
          channelId: formData.get('leveling.channelId') || null,
        },
        moderation: {
          autoMod: {
            enabled: document.querySelector('[name="moderation.autoMod.enabled"]').checked,
            antiSpam: document.querySelector('[name="moderation.autoMod.antiSpam"]').checked,
            antiLinks: document.querySelector('[name="moderation.autoMod.antiLinks"]').checked,
            antiInvites: document.querySelector('[name="moderation.autoMod.antiInvites"]').checked,
          },
          logChannelId: formData.get('moderation.logChannelId') || null,
        },
        economy: {
          daily: {
            amount: parseInt(formData.get('economy.daily.amount')) || 100,
          }
        }
      };

      try {
        const response = await fetch('/api/guild/<%= guild.id %>/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });

        if (response.ok) {
          showToast('✅ Settings saved successfully!', 'success');
        } else {
          const result = await response.json();
          showToast('❌ ' + (result.error || 'Failed to save'), 'error');
        }
      } catch (error) {
        showToast('❌ Network error', 'error');
      }
    });

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `fixed top-6 right-6 px-6 py-4 rounded-lg shadow-2xl transform transition-all z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
      }`;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
  </script>
</body>
</html>